# 跨平台支付记账分析工具实施方案（V4 · Final）

---

## 范围

| 版本 | 平台 | 核心能力 |
|---|---|---|
| **V1 MVP** | 支付宝 + 微信 | 解析 → 退款对冲 → 双轨分流 → LLM 打 L1+L2 标签 → Web UI |
| V2 | + 抖音/京东/美团 | 资金池深度分析、月环比异动检测、Agent Skill |

技术栈：Python 后端（pandas + Flask）· Vite 前端（Chart.js）· LLM 打标由 Agent 自身执行

---

## 一、数据解析

### 支付宝 — GB2312 CSV

- 前 24 行元数据，第 25 行表头，2009 笔
- 字段：交易时间 / **交易分类** ✅ / 交易对方 / 商品说明 / 收/支 / 金额 / 收/付款方式 / 交易状态 / 交易订单号 / 商家订单号

### 微信 — XLSX（4 季度文件）

- 前 16 行元数据，第 17 行表头，约 420 笔
- 字段：交易时间 / **交易类型** ⚠️ / 交易对方 / 商品 / 收/支 / 金额(元)（带 `¥`）/ 支付方式 / 当前状态 / 交易单号 / 商户单号
- **无消费分类**，需 LLM 打标

---

## 二、退款对冲（每平台独立）

### 支付宝：订单号拆分法

退款记录的订单号用 `_` 或 `*` 拼接原始订单号，拆分后精确匹配。

- **全额退款**（29 笔）：原始状态 = `交易关闭` → `effective = 0`
- **部分退款**（9 笔）：原始状态 = `交易成功` → `effective = original − refund`
- **未匹配**（3 笔）：跨年退款或保险退保，`收/支 = 不计收支`，直接归入 cashflow
- 退款行本身标记 `is_ignored = True`

### 微信：状态自描述法

不需要反向查找。直接读原始支出的 `当前状态` 字段：

| 状态 | 处理 |
|---|---|
| `已全额退款` | `effective = 0` |
| `已退款(￥XX.XX)` | `effective = amount − XX.XX` |
| `支付成功` / `对方已收钱` 等 | `effective = amount` |

退款收入行（`交易类型 = 'XXX-退款'`）标记 `is_ignored = True`。

---

## 三、双轨分流

### 支付宝

| 条件 | 轨道 |
|---|---|
| `收/支 = 不计收支` | cashflow |
| `交易分类 ∈ {转账红包, 投资理财, 信用借还, 收入}` | cashflow |
| `交易分类 = 退款` | 走退款对冲 |
| 其余支出 | **consumption** |

### 微信

| 交易类型 | 轨道 |
|---|---|
| `商户消费` | consumption |
| `扫二维码付款` + 状态=`支付成功` | consumption |
| `扫二维码付款` + 状态=`已转账` | cashflow |
| `转账 / 微信红包 / 二维码收款 / 群收款 / 转入零钱通` | cashflow |
| `XXX-退款` | 走退款对冲 |

---

## 四、L1 + L2 分类体系

> 从 2025 全年支付宝真实数据中收敛得出，覆盖微信通用。LLM 为两个平台打标时从此固定清单中选。

| L1 一级分类 | L2 二级分类 |
|---|---|
| **餐饮美食** | 外卖配送 · 堂食正餐 · 快餐简餐 · 咖啡饮品 · 自动售货/零食 · 生鲜超市 · 烘焙甜点 |
| **交通出行** | 高速/ETC · 网约车/打车 · 公共交通 · 租车 · 机票火车票 · 共享单车 |
| **爱车养车** | 停车费 · 新能源充电 · 加油 · 购车/车辆订单 · 车险 · 维修保养 · 洗车 |
| **住房物业** | 房租 · 物业费 · 水电燃气 |
| **日用百货** | 线上日杂 · 线下超市/便利店 · 日化清洁 |
| **服饰装扮** | 鞋靴 · 服装 · 箱包配饰 |
| **数码电器** | 手机/电子产品 · 电脑办公 · 智能家居 |
| **充值缴费** | 话费流量 · 会员订阅 · 水电燃气缴费 |
| **文化休闲** | 电影演出 · 会员/知识付费 · 书籍 · 按摩/休闲 · 文创/玩具 |
| **医疗健康** | 药品 · 就医/体检 |
| **商业服务** | ETC 办理 · 快递寄件 · 以旧换新 · 打印/办证 |
| **生活服务** | 快递 · 打印 · 家政 |
| **酒店旅游** | 酒店住宿 · 景区门票 · 签证 |
| **美容美发** | 美发 · 美容护肤 |
| **母婴亲子** | 玩具 · 母婴用品 |
| **家居家装** | 家具 · 五金建材 |
| **保险** | 人寿保险 · 财产保险 |
| **公共服务** | 政府缴费 · 公共设施 |
| **其他** | 未分类 |

> [!TIP]
> 支付宝有些原始分类有误（如"科拓停车费"被支付宝归入"数码电器"）。LLM 打标时会根据商户名+商品描述**纠正**这些错误，而非照搬平台原始分类。

---

## 五、LLM 打标

**范围**：支付宝 consumption 轨 + 微信 consumption 轨（共约 1500 条）

**流程**：批量 20 条一组，由 Agent 自身作为 LLM 执行。

**Prompt**（两个平台通用）：

```
你是财务分类专家。请为以下支付交易打上 L1 一级分类和 L2 二级分类。
必须从以下固定清单中选择：
[餐饮美食: 外卖配送/堂食正餐/快餐简餐/咖啡饮品/自动售货零食/生鲜超市/烘焙甜点]
[交通出行: 高速ETC/网约车打车/公共交通/租车/机票火车票/共享单车]
... (完整清单)

每条格式: [序号]. [交易对方] | [商品描述] | [金额]
返回 JSON: [{"index": 1, "l1": "餐饮美食", "l2": "外卖配送"}, ...]
```

- 支付宝：虽有平台分类，但 LLM 可修正错误（如科拓→停车费）并补打 L2
- 微信：从零打 L1 + L2

---

## 六、多用户

```python
USER_PROFILES = {
    "parko": {
        "display_name": "Parko",
        "aliases": ["Parko", "赵锡盛"],
        "alipay_account": "18211094248",
    },
}
```

从文件元数据自动匹配，UUL 记录带 `user_id`。

---

## 七、项目结构

```
SpendingAnalyser/
├── 参考材料/
├── Implementation_Plan/
├── data/                       # 原始 CSV/XLSX
├── src/
│   ├── parsers/
│   │   ├── base.py             # UUL Schema
│   │   ├── alipay.py           # GB2312 CSV parser
│   │   └── wechat.py           # XLSX parser（合并 4 季度）
│   ├── cleaners/
│   │   ├── refund_netting.py   # 平台独立退款逻辑
│   │   └── non_consumption.py  # 双轨分流
│   ├── classifiers/
│   │   ├── taxonomy.py         # L1+L2 固定清单 + 映射
│   │   └── llm_tagger.py       # LLM 打标接口
│   ├── users.py                # 多用户配置
│   ├── api.py                  # Flask REST API
│   └── main.py                 # 入口
├── frontend/                   # Vite + Chart.js
│   ├── index.html
│   ├── src/
│   │   ├── main.js
│   │   ├── api.js              # 调后端 API
│   │   ├── charts.js           # 图表渲染
│   │   └── style.css
│   └── vite.config.js
├── tests/
├── requirements.txt
└── .gitignore
```

---

## 八、Web UI 页面

1. **总览卡片**：总支出 · 净消费 · 退款额 · 非消费转移额
2. **分类饼图**：L1 饼图，点击下钻 L2
3. **时间趋势**：折线/柱状图，切换年/月/周
4. **Top 商户**：横向柱状图
5. **明细表格**：排序 · 搜索 · 按平台/分类/时间筛选
6. **资金流动面板**（V1 简版）：cashflow 轨总额与大类占比

---

## 九、执行步骤

| 步骤 | 内容 | 预计 |
|---|---|---|
| 1 | 搭建 Python 项目 + `base.py` UUL Schema | 快 |
| 2 | `alipay.py` + `wechat.py` 解析器 | 中 |
| 3 | `refund_netting.py` 退款对冲 | 中 |
| 4 | `non_consumption.py` 双轨分流 | 快 |
| 5 | `taxonomy.py` L1+L2 清单 + `llm_tagger.py` | 中 |
| 6 | `main.py` 串联 + `api.py` REST 接口 | 中 |
| 7 | 前端 Vite 项目 + 图表 | 较重 |
| 8 | 端到端测试 + 验证 | 中 |

---

## 十、Verification Plan

### Automated Tests
```bash
python -m pytest tests/ -v
```
- Parser：GB2312 / XLSX 解析、元数据跳过、¥ 去除、字段映射
- 退款对冲：`_`/`*` 分割（全额+部分）、微信状态解析
- 分流：支付宝 `不计收支` + 微信交易类型正确分轨

### Manual Verification
用真实 2025 数据端到端跑通，目视核对 Web UI 报告。重点检查退款、非消费过滤、分类准确性。
