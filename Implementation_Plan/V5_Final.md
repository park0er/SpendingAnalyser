# 跨平台支付记账分析工具实施方案（V5 · 完整融合版）

---

## 范围

| 版本 | 平台 | 核心能力 |
|---|---|---|
| **V1 MVP** | 支付宝 + 微信 | 解析 → 退款对冲 → 双轨分流 → LLM 打标 → Web UI |
| **V5 (当前)** | 支付宝 + 微信 + **京东 + 美团** | **统一架构的退款对冲与双轨分流**、**四平台多渠道差异化打标策略**、**大一统生态分类体系扩展** |

技术栈：Python 后端（pandas + Flask）· Vite 前端（Chart.js）· LLM 打标由 Agent 本地执行

---

## 一、数据解析与格式适配

| 平台 | 格式与表头 | 数据特点提取 |
|---|---|---|
| **支付宝** | GB2312 CSV (前24行元数据) | `交易分类` 有效；`收/支` 清晰 |
| **微信** | XLSX (前16行元数据) | 仅有 `交易类型`；自带 `状态` 描述退款 |
| **京东** | CSV (前21行元数据) | `交易分类` 详尽；金额列自带 `(已退款)` 备注 |
| **美团** | CSV (前18行元数据) | 无分类；`交易类型` 含有 `支付/退款/还款` |

---

## 二、退款对冲（多态处理法则）

四大平台的退款逻辑各异，在进入统一流程前，每个 Parser 负责各自的 `effective_amount` 计算：

1. **支付宝（订单拆分法）**
   - 依赖退款订单号用 `_` 或 `*` 拼接的规律反查原订单。
   - 原订单扣减 `effective_amount`，退款行本身标记为 `is_ignored = True`。
2. **微信（状态提取法）**
   - 直接读取原始支出行的 `当前状态`（如 `已全额退款` 或 `已退款(￥XX)`）来扣减 `effective_amount`。
   - 独立的退款收入行标记 `is_ignored = True`。
3. **京东（金额正则内联法）**
   - 观察到消费行的 `金额` 字段在发生退款时会变成如 `293.10(已全额退款)` 或 `2977.63(已退款2974.66)`。
   - 正则提取括号内的退款额度直接对冲该笔消费的 `effective_amount`。
   - 独立的退款行（`交易状态` = `退款成功`）标记 `is_ignored = True`。
4. **美团（分类对冲法）**
   - `交易类型` = `退款`，将提取到的 `实付金额` 作为负数赋值给 `effective_amount`，在月度统计中自然抵消。（若无法匹配原订单，直接挂载负数消费池）。

---

## 三、双轨分流 (Consumption vs. Cashflow)

| 平台 | Consumption (进入消费打标轨) | Cashflow / Ignored (资金流转轨) |
|---|---|---|
| **支付宝** | 剔除左侧条件后的纯支出 | `不计收支`、含红包理财借还等特定分类 |
| **微信** | 扫码付款成功、商户消费 | 转账/红包、零钱通、群收款、已转账 |
| **京东** | `收/支` = `支出` | `不计收支`、`收入` (如小金库、白条还款) |
| **美团** | `交易类型` = `支付` 且 `收/支` = `支出` | `交易类型` = `还款` 或 `退款` |

---

## 四、L1 + L2 大一统分类体系 (新增京东/美团适配)

在 V4 的基础上，为兼容京东的电商属性以及美团的同城生活属性，对分类体系进行了扩充（带 `*` 为新增）：

| L1 一级分类 | L2 二级分类 |
|---|---|
| **餐饮美食** | 外卖配送 · 堂食正餐 · 快餐简餐 · 咖啡饮品 · 自动售货/零食 · 生鲜超市 · 烘焙甜点 |
| **交通出行** | 高速/ETC · 网约车/打车 · 公共交通 · 机票火车票 · 共享单车 |
| **爱车养车** | 停车费 · 新能源充电 · 加油 · 购车/车辆订单 · 车险 · 维修保养 · 洗车 |
| **住房物业** | 房租 · 物业费 · 水电燃气 |
| **日用百货** | 线上日杂 · 线下超市/便利店 · 日化清洁 · **鲜花绿植*** |
| **服饰装扮** | 鞋靴 · 服装 · 箱包配饰 |
| **数码电器** | 手机/电子产品 · 电脑办公 · 智能家居 |
| **文化休闲** | 电影演出 · 会员/知识付费 · 书籍 · 按摩/休闲 · 文创/玩具 · **运动健身*** |
| **医疗健康** | 药品 · 就医/体检 · **保健品/器械*** |
| **美容美发** | 美发 · 美容护肤 · **美妆个护*** |
| **商业生活** | 快递寄件 · 打印/办证 · 以旧换新 |
| **酒店旅游** | 酒店住宿 · 景区门票 · 护照签证 · 等 |
| **其他** | 未分类 |

---

## 五、基于渠道差异的智能打标 (Mapping + LLM)

四个渠道的数据丰富度不同，采取不同的处理策略，最大化效率和准确率：

### 1. 强映射直接定 L1 (Alipay + JD)
- **支付宝**：自带 `交易分类`（如“日用百货”）。后端代码维护一个字典 `ALIPAY_L1_MAP` 强映射为我们自己的 L1。
- **京东**：自带 `交易分类`极为标准化。在 `jd_parser.py` 中建立字典强映射，例如：`医疗保健` → `医疗健康`；`美妆个护` → `美容美发`；`运动户外` → `文化休闲`。
- **降本增效**：对于这两个平台，LLM 只需要在这个强制规定的 L1 下去推断 L2，甚至对于特征极强的京东分类直接赋默认 L2（视置信度而定）。

### 2. 纯 LLM 全面推演 (WeChat + Meituan)
- **微信**：完全无分类结构，将 `交易对方` + `商品` 丢给 LLM 生成 L1 和 L2。
- **美团**：虽然无分类，但商户名和订单标题（如“瑞幸咖啡”、“柔力轩盲人推拿”）极具特征。与微信合并走 LLM 的全面推演。

### Prompt 策略调整
```
你是一个财务分类专家。请为以下交易打标。
如果我输入了预设的 L1，请你仅为它挑选合适的 L2。
如果我没输入 L1，请你同时为它挑选 L1 和 L2。

列表格式: [预设L1] | [商户名/交易对方] | [商品描述] | [金额]
(预设 L1 可能为空白)
```

---

## 六、执行与替换计划

### 第一步：后端数据处理层扩容
- 创建 `src/parsers/jd_parser.py` 及 `meituan_parser.py` 实现退款与分流逻辑。
- 更新 `src/classifiers/taxonomy.py`，加入新增的二级分类和 `JD_L1_MAP`。
- 修改 `llm_tagger.py` 拥抱可选参数 `preset_l1`，实现强映射和纯推理的混合工作流。

### 第二步：流水线融合
- 修改主管道识别规则，增加对京东与美团 CSV 的格式匹配与 Parser 路由。
- 汇总四大平台 DataFrame 进入同一个消费池。

### 第三步：验证前端
- 验证原有的 API和前端组件是否能完美兼容新增的来源标签和类别。目前看来架构是 decouple 的，可以无缝呈现。
