# 跨平台支付记账分析工具实施方案（V6.1 · Final）

---

## 范围

| 里程碑 | 覆盖平台 | 核心能力 |
|---|---|---|
| **V1 MVP** （已完成） | 支付宝 + 微信 | 解析 → 退款对冲 → 双轨分流 → LLM 打标 → Web UI |
| **V6.1 增量** （本次） | + **京东 + 美团** | 新增两平台 Parser → 各自退款对冲 → 各自双轨分流 → **统一 LLM 打标** → 分类体系扩充 |

技术栈：Python 后端（pandas + Flask）· Vite 前端（Chart.js）· LLM 打标由 Agent 自身执行

---

## 一、数据解析

### 支付宝 — GB2312 CSV（已实现）

- 前 24 行元数据，第 25 行表头，2009 笔
- 字段：交易时间 / **交易分类** ✅ / 交易对方 / 商品说明 / 收/支 / 金额 / 收/付款方式 / 交易状态 / 交易订单号 / 商家订单号

### 微信 — XLSX · 4 季度文件（已实现）

- 前 16 行元数据，第 17 行表头，约 420 笔
- 字段：交易时间 / **交易类型** ⚠️ / 交易对方 / 商品 / 收/支 / 金额(元)（带 `¥`）/ 支付方式 / 当前状态 / 交易单号 / 商户单号
- **无消费分类**，需 LLM 打标

### 京东 — CSV（V6 新增）

- 前 21 行元数据与提示，第 22 行为真正表头
- 字段：交易时间 / **商户名称** / **交易说明** / **金额** / 收/付款方式 / 交易状态 / **收/支** / **交易分类** ✅ / 交易订单号 / 商家订单号 / 备注
- 平台自带分类较细（医疗保健、运动户外、鞋服箱包等），但**不直接信赖**，统一走 LLM 打标
- 金额字段可能包含退款信息（如 `293.10(已全额退款)` 或 `2977.63(已退款2974.66)`），需正则提取

### 美团 — CSV · 4 季度文件（V6 新增）

- 前约 19 行元数据与提示（以 `【美团交易账单明细列表】` 行作为表头定位标志），其下一行为真正表头
- 字段：交易创建时间 / 交易成功时间 / **交易类型**（支付/退款/还款）/ **订单标题** / **收/支** / 支付方式 / 订单金额 / **实付金额**（带 `¥`）/ 交易单号 / 商家单号 / 备注
- **无消费分类**，需 LLM 打标
- 文件名为 `美团账单(YYYYMMDD-YYYYMMDD).csv`，季度分文件，需合并读取

---

## 二、退款对冲（每平台独立）

### 支付宝：订单号拆分法（已实现）

退款记录的订单号用 `_` 或 `*` 拼接原始订单号，拆分后精确匹配。

- **全额退款**（29 笔）：原始状态 = `交易关闭` → `effective = 0`
- **部分退款**（9 笔）：原始状态 = `交易成功` → `effective = original − refund`
- **未匹配**（3 笔）：跨年退款或保险退保，`收/支 = 不计收支`，直接归入 cashflow
- 退款行本身标记 `is_ignored = True`

### 微信：状态自描述法（已实现）

不需要反向查找。直接读原始支出的 `当前状态` 字段：

| 状态 | 处理 |
|---|---|
| `已全额退款` | `effective = 0` |
| `已退款(￥XX.XX)` | `effective = amount − XX.XX` |
| `支付成功` / `对方已收钱` 等 | `effective = amount` |

退款收入行（`交易类型 = 'XXX-退款'`）标记 `is_ignored = True`。

### 京东：金额内联正则法（V6 新增）

京东的退款信息**内嵌在支出记录的金额字段中**，而非独立退款行关联：

| 金额字段格式 | 解析规则 |
|---|---|
| `293.10(已全额退款)` | `effective = 0` |
| `2977.63(已退款2974.66)` | `effective = 2977.63 − 2974.66 = 2.97`  |
| `375.00` （纯数字） | `effective = 375.00` |

此外，独立的退款行（`交易状态` = `退款成功`）标记 `is_ignored = True`，不重复计入。

### 美团：相邻行反向匹配法（V6.1 更新）

美团的退款以独立的 `交易类型 = 退款` 行存在。通过观察真实数据发现，退款行通常**紧邻其对应的原始支出行**（在前后几行范围内），且**商户名一致**。因此采用程序化的相邻行匹配，而非大模型判断：

**匹配算法**：
1. 遍历所有美团记录，遇到 `交易类型 = 退款` 的行时触发回溯。
2. 从退款行的位置往前搜索最近 **10 行**，寻找满足以下条件的支出行：
   - `交易类型 = 支付` 且 `收/支 = 支出`
   - 订单标题中的**商户名关键词匹配**（提取退款行和支出行标题中的店铺名进行模糊比较）
   - 退款金额 ≤ 原始支出金额
   - 时间差在 **7 天以内**（可选辅助条件）
3. **匹配成功**：扣减原始支出行的 `effective_amount`，退款行标记 `is_ignored = True`。
4. **匹配失败**（极少数跨文件或无法关联的情况）：退款行保留为负数 `effective_amount`，在统计时自然抵消。

---

## 三、双轨分流

### 支付宝（已实现）

| 条件 | 轨道 |
|---|---|
| `收/支 = 不计收支` | cashflow |
| `交易分类 ∈ {转账红包, 投资理财, 信用借还, 收入}` | cashflow |
| `交易分类 = 退款` | 走退款对冲 |
| 其余支出 | **consumption** |

### 微信（已实现）

| 交易类型 | 轨道 |
|---|---|
| `商户消费` | consumption |
| `扫二维码付款` + 状态=`支付成功` | consumption |
| `扫二维码付款` + 状态=`已转账` | cashflow |
| `转账 / 微信红包 / 二维码收款 / 群收款 / 转入零钱通` | cashflow |
| `XXX-退款` | 走退款对冲 |

### 京东（V6 新增）

| 条件 | 轨道 |
|---|---|
| `收/支` = `支出` 且 `交易状态` ≠ `退款成功` | **consumption** |
| `收/支` = `不计收支`（白条还款、小金库转账、预授权冻结/解冻等） | cashflow |
| `收/支` = `收入`（小金库红包等） | cashflow |
| `交易状态` = `退款成功` | 走退款对冲 |

### 美团（V6 新增）

| 条件 | 轨道 |
|---|---|
| `交易类型` = `支付` 且 `收/支` = `支出` | **consumption** |
| `交易类型` = `还款`（美团月付代扣还款） | cashflow |
| `交易类型` = `退款` | 走退款对冲 |

---

## 四、L1 + L2 分类体系

> 从 V4 的支付宝+微信基础收敛而来，V6 为兼容京东电商和美团同城生活场景进行了扩充。带 ⭐ 为 V6 新增 L2。

| L1 一级分类 | L2 二级分类 |
|---|---|
| **餐饮美食** | 外卖配送 · 堂食正餐 · 快餐简餐 · 咖啡饮品 · 自动售货/零食 · 生鲜超市 · 烘焙甜点 |
| **交通出行** | 高速/ETC · 网约车/打车 · 公共交通 · 机票火车票 · 共享单车 |
| **爱车养车** | 停车费 · 新能源充电 · 加油 · 购车/车辆订单 · 车险 · 维修保养 · 洗车 |
| **住房物业** | 房租 · 物业费 · 水电燃气 |
| **日用百货** | 线上日杂 · 线下超市/便利店 · 日化清洁 · **鲜花绿植** ⭐ |
| **服饰装扮** | 鞋靴 · 服装 · 箱包配饰 |
| **数码电器** | 手机/电子产品 · 电脑办公 · 智能家居 |
| **充值缴费** | 话费流量 · 会员订阅 · 水电燃气缴费 |
| **文化休闲** | 电影演出 · 会员/知识付费 · 书籍 · 按摩/休闲 · 文创/玩具 · **运动健身** ⭐ |
| **医疗健康** | 药品 · 就医/体检 · **保健品/器械** ⭐ |
| **美容美发** | 美发 · 美容护肤 · **美妆个护** ⭐ |
| **商业服务** | ETC 办理 · 快递寄件 · 以旧换新 · 打印/办证 |
| **生活服务** | 快递 · 打印 · 家政 |
| **酒店旅游** | 酒店住宿 · 景区门票 · 护照签证 · 旅行保险 · 旅行团费/套餐 · 导游/游玩项目 · 旅游杂费 · 机票火车票 · 租车 |
| **母婴亲子** | 玩具 · 母婴用品 |
| **家居家装** | 家具 · 五金建材 |
| **保险** | 人寿保险 · 财产保险 |
| **公共服务** | 政府缴费 · 公共设施 |
| **其他** | 未分类 |

> [!TIP]
> 支付宝有些原始分类有误（如"科拓停车费"被支付宝归入"数码电器"），京东也存在类似情况（如按摩仪被标为"美妆个护"）。LLM 统一打标时会根据商户名+商品描述**纠正**这些错误，而非照搬任何平台的原始分类。

---

## 五、LLM 打标

> [!IMPORTANT]
> **V6 核心决策：所有平台统一走 LLM 打标**，不再区分"强映射"和"LLM"两条路径。无论支付宝、微信、京东还是美团，L1 和 L2 均由 LLM 根据交易对方 + 商品描述 + 金额 统一判定。这保证了跨平台分类的一致性，也避免了平台原始分类有误时产生的错误传播。

**范围**：所有四个平台的 consumption 轨记录

**流程**：批量 20 条一组，由 Agent 自身作为 LLM 执行。

**Prompt**（四平台通用）：

```
你是财务分类专家。请为以下支付交易打上 L1 一级分类和 L2 二级分类。
必须从以下固定清单中选择分类：

[餐饮美食: 外卖配送/堂食正餐/快餐简餐/咖啡饮品/自动售货零食/生鲜超市/烘焙甜点]
[交通出行: 高速ETC/网约车打车/公共交通/机票火车票/共享单车]
[爱车养车: 停车费/新能源充电/加油/购车车辆订单/车险/维修保养/洗车]
[住房物业: 房租/物业费/水电燃气]
[日用百货: 线上日杂/线下超市便利店/日化清洁/鲜花绿植]
[服饰装扮: 鞋靴/服装/箱包配饰]
[数码电器: 手机电子产品/电脑办公/智能家居]
[充值缴费: 话费流量/会员订阅/水电燃气缴费]
[文化休闲: 电影演出/会员知识付费/书籍/按摩休闲/文创玩具/运动健身]
[医疗健康: 药品/就医体检/保健品器械]
[美容美发: 美发/美容护肤/美妆个护]
[商业服务: ETC办理/快递寄件/以旧换新/打印办证]
[生活服务: 快递/打印/家政]
[酒店旅游: 酒店住宿/景区门票/护照签证/旅行保险/旅行团费套餐/导游游玩项目/旅游杂费/机票火车票/租车]
[母婴亲子: 玩具/母婴用品]
[家居家装: 家具/五金建材]
[保险: 人寿保险/财产保险]
[公共服务: 政府缴费/公共设施]
[其他: 未分类]

每条格式: [序号]. [来源平台] [交易对方] | [商品描述] | ¥[金额] (平台原标签: XXX)
返回 JSON: [{"index": 1, "l1": "餐饮美食", "l2": "外卖配送"}, ...]

注意：
- 如果平台原始分类有误（例如停车费被标为"数码电器"），请根据商户名和描述纠正
- 对于模糊的记录，根据商户名推断最可能的分类
- L2 必须属于对应 L1 下的子分类
```

### 硬编码特殊规则（Prompt 内嵌）

以下规则直接写入 Prompt 的"注意"部分，优先级高于 LLM 自主推断：

| 规则 | 匹配条件 | 强制打标 |
|---|---|---|
| **麦当劳早餐咖啡** | 交易对方包含"麦当劳" 且 金额 = 9.9 | L1=`餐饮美食`，L2=`咖啡饮品` |

> [!NOTE]
> 此规则源于实际消费习惯：金额恰好为 9.9 的麦当劳订单通常是早餐咖啡套餐，默认会被 LLM 归为"快餐简餐"，但实际应归入"咖啡饮品"。通过硬编码在 Prompt 中，确保这类高频交易始终被正确分类。后续如有类似的特殊规则，可在此表中追加。

### 各平台提供给 LLM 的字段

| 平台 | 交易对方 | 商品描述 | 辅助参考 |
|---|---|---|---|
| 支付宝 | `交易对方` | `商品说明` | `交易分类`（仅参考，不可直映） |
| 微信 | `交易对方` | `商品` | — |
| 京东 | `商户名称` | `交易说明` | `交易分类`（仅参考，不可直映） |
| 美团 | 从`订单标题`中提取店铺名 | `订单标题` | — |

---

## 5.5 标签继承机制（Tag Inheritance）

> [!IMPORTANT]
> **核心诉求**：已通过 Web UI 手动修正的 L1/L2 分类标签，在端到端重跑 pipeline 后必须完整保留，不可丢失。

**问题**：每次端到端重跑 pipeline 会重新生成 `processed_data.csv`，支付宝和微信的已有标注会被清空，需要重新 LLM 打标。

**方案**：基于 `transaction_id` 精确合并（而非文件级覆盖），仅回填 L1/L2 两列，不影响其他字段。

**流程**（在 pipeline 的 LLM 打标批次生成**之前**执行）：

```
Step 0: 首次运行前，从现有 processed_data.csv 提取标注资产
        → output/tag_overrides.csv
        → 字段: transaction_id, source_platform, global_category_l1, global_category_l2
        → 仅保留 consumption 轨且 L2 非空的记录

Step A: Pipeline 正常执行（解析 → 退款对冲 → 双轨分流）

Step B: 标签继承 —— 读取 tag_overrides.csv，按 (transaction_id, source_platform)
        做 LEFT JOIN，将旧标签回填到新 DataFrame 的 L1/L2 列

Step C: LLM 打标 —— 仅对 L2 仍为空的 consumption 记录生成打标批次
        → 支付宝/微信中已有标签的记录被跳过
        → 京东/美团新记录进入 LLM 打标
```

**实现位置**：`src/main.py` 的 `run_pipeline()` 中，在 Step 4（track classification）之后、Step 5（LLM batch generation）之前插入。

**新增工具函数**：

| 函数 | 位置 | 作用 |
|---|---|---|
| `export_tag_overrides(df, path)` | `src/classifiers/llm_tagger.py` | 从 DataFrame 导出标注资产文件 |
| `apply_tag_inheritance(df, overrides_path)` | `src/classifiers/llm_tagger.py` | 按 `transaction_id` 回填已有 L1/L2 |

> [!TIP]
> `tag_overrides.csv` 只需在首次迁移时手动生成一次。后续每次 pipeline 运行结束后，可自动更新该文件（追加新打标的记录），实现累积继承。

## 六、多用户

```python
USER_PROFILES = {
    "parko": {
        "display_name": "Parko",
        "aliases": ["Parko", "赵锡盛"],
        "alipay_account": "18211094248",
    },
}
```

从文件元数据自动匹配，UUL 记录带 `user_id`。

---

## 七、项目结构

```
SpendingAnalyser/
├── 参考材料/
├── Implementation_Plan/
├── data/                       # 原始 CSV/XLSX
├── src/
│   ├── parsers/
│   │   ├── base.py             # UUL Schema
│   │   ├── alipay.py           # GB2312 CSV parser（已实现）
│   │   ├── wechat.py           # XLSX parser（已实现）
│   │   ├── jd.py               # 京东 CSV parser（V6 新增）
│   │   └── meituan.py          # 美团 CSV parser（V6 新增）
│   ├── cleaners/
│   │   ├── refund_netting.py   # 平台独立退款逻辑
│   │   └── non_consumption.py  # 双轨分流
│   ├── classifiers/
│   │   ├── taxonomy.py         # L1+L2 固定清单
│   │   └── llm_tagger.py       # LLM 打标接口
│   ├── users.py                # 多用户配置
│   ├── api.py                  # Flask REST API
│   └── main.py                 # 入口
├── frontend/                   # Vite + Chart.js
│   ├── index.html
│   ├── src/
│   │   ├── main.js
│   │   ├── api.js              # 调后端 API
│   │   ├── charts.js           # 图表渲染
│   │   └── style.css
│   └── vite.config.js
├── tests/
├── requirements.txt
└── .gitignore
```

---

## 八、Web UI 页面

1. **总览卡片**：总支出 · 净消费 · 退款额 · 非消费转移额
2. **分类饼图**：L1 饼图，点击下钻 L2
3. **时间趋势**：折线/柱状图，切换年/月/周
4. **Top 商户**：横向柱状图
5. **明细表格**：排序 · 搜索 · 按平台/分类/时间筛选
6. **资金流动面板**（V1 简版）：cashflow 轨总额与大类占比

---

## 九、V6 增量实施：最小化改动方案

> [!NOTE]
> 以下方案基于已完成的 V1 MVP 代码（支付宝 + 微信已完整实现：Parser、退款对冲、双轨分流、LLM 打标、Web UI 均可运行）。目标是在**不破坏现有程序运行**的前提下，以最小改动量接入京东和美团。

### 9.1 新增文件（不触及任何已有文件）

| 新文件 | 说明 |
|---|---|
| `src/parsers/jd.py` | 京东 Parser：跳过前 21 行元数据 → 读取 CSV → 金额正则提取退款 → 映射至 UUL Schema |
| `src/parsers/meituan.py` | 美团 Parser：定位 `【美团交易账单明细列表】` → 读取下方数据 → 去除 `¥` → 映射至 UUL Schema |

每个 Parser 的 `source_platform` 字段分别写入 `"jd"` 和 `"meituan"`，确保后续流程可按平台识别。

### 9.2 最小修改已有文件

#### (a) `src/main.py`（加挂新 Parser 到 pipeline）

在 Step 1 解析阶段，**追加**京东和美团的文件识别与解析，不修改已有的支付宝/微信逻辑：

```python
# 在已有的 alipay/wechat 导入之后追加
from .parsers.jd import parse_jd
from .parsers.meituan import parse_meituan

# 在 Step 1 的 dfs 收集循环中追加：
# JD CSV files
for f in sorted(data_path.glob("京东交易流水*.csv")):
    print(f"  → JD: {f.name}")
    df = parse_jd(str(f))
    dfs.append(df)

# Meituan CSV files
for f in sorted(data_path.glob("美团账单*.csv")):
    print(f"  → Meituan: {f.name}")
    df = parse_meituan(str(f))
    dfs.append(df)
```

#### (b) `src/cleaners/refund_netting.py`（追加两个退款函数）

新增 `_net_jd_refunds()` 和 `_net_meituan_refunds()` 函数，并在 `apply_refund_netting()` 中追加调用：

```python
df = _net_jd_refunds(df)
df = _net_meituan_refunds(df)
```

已有的 `_net_alipay_refunds()` 和 `_net_wechat_refunds()` 完全不动。

> [!NOTE]
> 美团退款函数 `_net_meituan_refunds()` 采用**相邻行反向匹配算法**（详见第二章），以商户名关键词模糊匹配 + 金额校验，在前后 10 行范围内关联退款行和原始支出行。

#### (c) `src/cleaners/non_consumption.py`（追加两个分流函数）

新增 `_classify_jd_track()` 和 `_classify_meituan_track()` 函数，并在 `apply_track_classification()` 的 for 循环中追加分支：

```python
elif row["source_platform"] == "jd":
    df.at[idx, "track"] = _classify_jd_track(row)
elif row["source_platform"] == "meituan":
    df.at[idx, "track"] = _classify_meituan_track(row)
```

已有的支付宝/微信分流逻辑完全不动。

#### (d) `src/classifiers/taxonomy.py`（扩充 L2 分类）

在 `TAXONOMY` 字典中为对应的 L1 追加新的 L2 条目：

```diff
- "日用百货": ["线上日杂", "线下超市/便利店", "日化清洁"],
+ "日用百货": ["线上日杂", "线下超市/便利店", "日化清洁", "鲜花绿植"],

- "文化休闲": ["电影演出", "会员/知识付费", "书籍", "按摩/休闲", "文创/玩具"],
+ "文化休闲": ["电影演出", "会员/知识付费", "书籍", "按摩/休闲", "文创/玩具", "运动健身"],

- "医疗健康": ["药品", "就医/体检"],
+ "医疗健康": ["药品", "就医/体检", "保健品/器械"],

- "美容美发": ["美发", "美容护肤"],
+ "美容美发": ["美发", "美容护肤", "美妆个护"],
```

同时，废弃 `ALIPAY_L1_MAP` 和 `apply_alipay_l1_mapping()`（因所有平台统一走 LLM），并相应移除 `main.py` Step 4 中对它的调用。

#### (e) `src/classifiers/llm_tagger.py`（Prompt 更新）

更新 `SYSTEM_PROMPT` 以覆盖新增的 L2 分类，并在输入格式中加入 `[来源平台]` 字段。保留现有麦当劳硬编码规则。

### 9.3 不需要修改的文件

| 文件 | 理由 |
|---|---|
| `src/parsers/base.py` | UUL Schema 已通用，无需改动 |
| `src/parsers/alipay.py` | 已完成，不触及 |
| `src/parsers/wechat.py` | 已完成，不触及 |
| `src/api.py` | API 对 DataFrame 操作是通用的，不感知具体平台 |
| `src/users.py` | 多用户逻辑不受影响 |
| `frontend/*` | 前端按照 L1/L2 和 `source_platform` 渲染，新平台数据进入后自动呈现 |

### 9.4 改动量总结

| 类型 | 文件数 | 改动幅度 |
|---|---|---|
| **新增** | 2 | `jd.py` + `meituan.py`（约 150 行/文件） |
| **追加逻辑** | 3 | `main.py` + `refund_netting.py` + `non_consumption.py`（各追加 10-30 行） |
| **小幅修改** | 2 | `taxonomy.py`（4 行 diff） + `llm_tagger.py`（Prompt 更新） |
| **不动** | 7+ | 所有前端、API、Schema、现有 Parser |

---

## 十、执行步骤

| 步骤 | 内容 | 预计 | 状态 |
|---|---|---|---|
| 1 | 搭建 Python 项目 + `base.py` UUL Schema | 快 | ✅ 已完成 |
| 2 | `alipay.py` + `wechat.py` 解析器 | 中 | ✅ 已完成 |
| 3 | `refund_netting.py` 退款对冲 | 中 | ✅ 已完成 |
| 4 | `non_consumption.py` 双轨分流 | 快 | ✅ 已完成 |
| 5 | `taxonomy.py` L1+L2 清单 + `llm_tagger.py` | 中 | ✅ 已完成 |
| 6 | `main.py` 串联 + `api.py` REST 接口 | 中 | ✅ 已完成 |
| 7 | 前端 Vite 项目 + 图表 | 较重 | ✅ 已完成 |
| 8 | 端到端测试 + 验证（支付宝+微信） | 中 | ✅ 已完成 |
| **9** | **`jd.py` + `meituan.py` 新 Parser** | **中** | 🔜 待实施 |
| **10** | **`refund_netting.py` + `non_consumption.py` 追加京东/美团逻辑** | **快** | 🔜 待实施 |
| **11** | **`taxonomy.py` 扩充 + `llm_tagger.py` Prompt 更新** | **快** | 🔜 待实施 |
| **11.5** | **标签继承：导出 `tag_overrides.csv` + pipeline 插入回填逻辑** | **快** | 🔜 待实施 |
| **12** | **`main.py` 挂载新 Parser + 端到端验证** | **中** | 🔜 待实施 |

---

## 十一、Verification Plan

### Automated Tests
```bash
python -m pytest tests/ -v
```
- Parser：GB2312 / XLSX / 京东 CSV / 美团 CSV 解析、元数据跳过、`¥` 去除、金额正则提取、字段映射
- 退款对冲：支付宝 `_`/`*` 分割、微信状态解析、京东金额内联提取、**美团相邻行匹配**
- 分流：四平台各自双轨正确分流

### Manual Verification
用真实 2025 数据端到端跑通，目视核对 Web UI 报告。重点检查：
- **标签继承**：重跑后，支付宝/微信中之前手动修正的 L1/L2 是否完整保留（抽样对比 `tag_overrides.csv`）
- **增量打标**：LLM 批次中是否仅包含京东/美团新记录和未打标的旧记录，已有标签的记录不重复出现
- 京东白条还款、预授权等是否正确进入 cashflow
- 美团月付还款是否正确过滤
- **美团退款是否正确匹配到原始支出并扣减 `effective_amount`**
- 新增 L2 分类（鲜花绿植、运动健身、保健品/器械、美妆个护）是否被 LLM 正确使用
- 麦当劳 ¥9.9 订单是否始终被打标为 L2="咖啡饮品"
- 四平台消费总计与手动抽样核对一致
